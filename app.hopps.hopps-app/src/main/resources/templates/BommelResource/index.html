{#include main.html}
{#title}Bommels - Hopps Buchhaltung{/title}

{#moreStyles}
<style>
  .bommels-layout {
    display: flex;
    gap: var(--cds-spacing-07);
    flex-wrap: wrap;
    padding: var(--cds-spacing-05) 0;
  }
  .tree-panel {
    flex: 1;
    min-width: 300px;
  }
  .detail-panel {
    flex: 2;
    min-width: 400px;
    display: flex;
    flex-direction: column;
    gap: var(--cds-spacing-05);
  }
  .detail-panel .box {
    margin-bottom: 0;
  }
  .form-row {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
    margin-bottom: 1rem;
  }
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 1;
    margin-bottom: 1rem;
  }
  .form-group.icon-input {
    max-width: 140px;
  }
  .form-group label {
    font-size: 0.875rem;
    color: #525252;
  }
  .form-group input,
  .form-group select {
    height: 40px;
    padding: 0 1rem;
    border: none;
    border-bottom: 1px solid #8d8d8d;
    background-color: #f4f4f4;
    font-size: 0.875rem;
    outline: none;
  }
  .form-group input:focus,
  .form-group select:focus {
    border-bottom: 2px solid #0f62fe;
  }
  .form-group input.error,
  .form-group select.error {
    border-bottom: 2px solid #da1e28;
  }
  .icon-picker {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    padding: 0.5rem 0;
    margin-bottom: 0.5rem;
  }
  .icon-option {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid transparent;
    border-radius: 4px;
    background: #f4f4f4;
    cursor: pointer;
    transition: all 0.15s;
  }
  .icon-option:hover {
    background: #e0e0e0;
  }
  .icon-option.selected {
    border-color: #0f62fe;
    background: #d0e2ff;
  }
  .icon-option input {
    display: none;
  }
  .icon-option svg {
    width: 24px;
    height: 24px;
  }
  .error-text {
    color: #da1e28;
    font-size: 0.75rem;
  }
  cds-tree-node {
    cursor: pointer;
  }
  .button-row {
    display: flex;
    gap: 1rem;
  }
  /* Native button styled like Carbon */
  button.cds-btn {
    height: 48px;
    padding: 0 1rem;
    border: none;
    font-size: 0.875rem;
    font-weight: 400;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  button.cds-btn-primary {
    background-color: #0f62fe;
    color: white;
  }
  button.cds-btn-primary:hover {
    background-color: #0353e9;
  }
  button.cds-btn-secondary {
    background-color: #393939;
    color: white;
  }
  button.cds-btn-secondary:hover {
    background-color: #4c4c4c;
  }
  button.cds-btn-danger {
    background-color: #da1e28;
    color: white;
  }
  button.cds-btn-danger:hover {
    background-color: #b81921;
  }
  button.cds-btn:disabled {
    background-color: #c6c6c6;
    color: #8d8d8d;
    cursor: not-allowed;
  }
</style>
{/moreStyles}

{#moreScripts}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('cds-tree-node').forEach(function(node) {
      node.addEventListener('click', function(e) {
        e.stopPropagation();
        var id = this.getAttribute('data-id');
        if (id) {
          window.location.href = '/bommels?selectedId=' + id;
        }
      });
    });
  });
</script>
{/moreScripts}

<div class="bommels-layout">
  <div class="tree-panel">
    <div class="box">
      <h2 class="box-header">Organisationsstruktur</h2>

      {#if root}
        <cds-tree-view label="Bommels">
          {#bommelNode root selected=selected /}
        </cds-tree-view>
      {#else}
        <p>Noch keine Organisationsstruktur definiert.</p>

        <h3 style="margin-top: 1rem;">Wurzel-Bommel erstellen</h3>
        {#form uri:BommelResource.createRoot()}
          <div class="form-group">
            <label>Symbol</label>
            {#iconPicker "home" name="icon" /}
          </div>
          <div class="form-group">
            <label for="title">Titel</label>
            <input type="text" id="title" name="title" placeholder="Organisationsname" {#ifError 'title'}class="error"{/ifError}>
            {#ifError 'title'}<span class="error-text">{#error 'title'/}</span>{/ifError}
          </div>
          <button type="submit" class="cds-btn cds-btn-primary">Erstellen</button>
        {/form}
      {/if}
    </div>
  </div>

  <div class="detail-panel">
    {#if selected}
      <div class="box">
        <h2 class="box-header" style="display: flex; align-items: center; gap: 0.5rem;">
          {#carbonIcon selected.icon /}
          Bearbeiten: {selected.getDisplayLabel}
        </h2>

        {#form uri:BommelResource.update()}
          <input type="hidden" name="id" value="{selected.id}">
          <div class="form-group">
            <label>Symbol</label>
            {#iconPicker selected.icon name="icon" /}
          </div>
          <div class="form-group">
            <label for="edit-title">Titel</label>
            <input type="text" id="edit-title" name="title" value="{selected.title}" {#ifError 'title'}class="error"{/ifError}>
            {#ifError 'title'}<span class="error-text">{#error 'title'/}</span>{/ifError}
          </div>
          <button type="submit" class="cds-btn cds-btn-primary">Speichern</button>
        {/form}
      </div>

      <div class="box">
        <h3 class="box-header" style="display: flex; align-items: center; gap: 0.5rem;">
          {#carbonIcon selected.icon /}
          Kind hinzufügen zu {selected.getDisplayLabel}
        </h3>

        {#form uri:BommelResource.addChild()}
          <input type="hidden" name="parentId" value="{selected.id}">
          <div class="form-group">
            <label>Symbol</label>
            {#iconPicker "folder" name="icon" /}
          </div>
          <div class="form-group">
            <label for="child-title">Titel</label>
            <input type="text" id="child-title" name="title" placeholder="Name" {#ifError 'title'}class="error"{/ifError}>
            {#ifError 'title'}<span class="error-text">{#error 'title'/}</span>{/ifError}
          </div>
          <button type="submit" class="cds-btn cds-btn-secondary">Hinzufügen</button>
        {/form}
      </div>

      <div class="box">
        <h3 class="box-header">Gefahrenzone</h3>
        {#if selected.hasChildren}
          <p>Dieser Bommel kann nicht gelöscht werden, da er Kinder hat. Entfernen Sie zuerst alle Kinder.</p>
          <button type="button" class="cds-btn cds-btn-danger" disabled>Bommel löschen</button>
        {#else}
          {#form uri:BommelResource.delete()}
            <input type="hidden" name="id" value="{selected.id}">
            <button type="submit" class="cds-btn cds-btn-danger">Bommel löschen</button>
          {/form}
        {/if}
      </div>
    {#else if root}
      <div class="box">
        <h2 class="box-header">Bommel auswählen</h2>
        <p>Klicken Sie auf einen Bommel im Baum, um seine Details anzuzeigen und zu bearbeiten.</p>
      </div>
    {/if}
  </div>
</div>

{#if flash:success}
  <cds-inline-notification
    kind="success"
    title="Erfolg"
    subtitle="{flash:success}"
    style="position: fixed; bottom: 1rem; right: 1rem;">
  </cds-inline-notification>
{/if}

{#if flash:error}
  <cds-inline-notification
    kind="error"
    title="Fehler"
    subtitle="{flash:error}"
    style="position: fixed; bottom: 1rem; right: 1rem;">
  </cds-inline-notification>
{/if}

{/include}
