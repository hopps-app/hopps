{#include main.html}
{#title}Bommels - Fuggs Bookkeeping{/title}

{#moreStyles}
<style>
  .bommels-layout {
    display: flex;
    gap: var(--cds-spacing-05);
    flex-wrap: wrap;
  }
  .tree-panel {
    flex: 1;
    min-width: 300px;
  }
  .detail-panel {
    flex: 2;
    min-width: 400px;
  }
  .form-row {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
    margin-bottom: 1rem;
  }
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 1;
  }
  .form-group.emoji-input {
    max-width: 80px;
  }
  .form-group label {
    font-size: 0.875rem;
    color: #525252;
  }
  .form-group input {
    height: 40px;
    padding: 0 1rem;
    border: none;
    border-bottom: 1px solid #8d8d8d;
    background-color: #f4f4f4;
    font-size: 0.875rem;
    outline: none;
  }
  .form-group input:focus {
    border-bottom: 2px solid #0f62fe;
  }
  .form-group input.error {
    border-bottom: 2px solid #da1e28;
  }
  .error-text {
    color: #da1e28;
    font-size: 0.75rem;
  }
  cds-tree-node {
    cursor: pointer;
  }
  .button-row {
    display: flex;
    gap: 1rem;
  }
  /* Native button styled like Carbon */
  button.cds-btn {
    height: 48px;
    padding: 0 1rem;
    border: none;
    font-size: 0.875rem;
    font-weight: 400;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  button.cds-btn-primary {
    background-color: #0f62fe;
    color: white;
  }
  button.cds-btn-primary:hover {
    background-color: #0353e9;
  }
  button.cds-btn-secondary {
    background-color: #393939;
    color: white;
  }
  button.cds-btn-secondary:hover {
    background-color: #4c4c4c;
  }
  button.cds-btn-danger {
    background-color: #da1e28;
    color: white;
  }
  button.cds-btn-danger:hover {
    background-color: #b81921;
  }
  button.cds-btn:disabled {
    background-color: #c6c6c6;
    color: #8d8d8d;
    cursor: not-allowed;
  }
</style>
{/moreStyles}

{#moreScripts}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('cds-tree-node').forEach(function(node) {
      node.addEventListener('click', function(e) {
        e.stopPropagation();
        var id = this.getAttribute('data-id');
        if (id) {
          window.location.href = '/Bommels/index?selectedId=' + id;
        }
      });
    });
  });
</script>
{/moreScripts}

<div class="bommels-layout">
  <div class="tree-panel">
    <div class="box">
      <h2 class="box-header">Organization Structure</h2>

      {#if root}
        <cds-tree-view label="Bommels">
          {#bommelNode root /}
        </cds-tree-view>
      {#else}
        <p>No organization structure defined yet.</p>

        <h3 style="margin-top: 1rem;">Create Root Bommel</h3>
        {#form uri:Bommels.createRoot()}
          <div class="form-row">
            <div class="form-group emoji-input">
              <label for="emoji">Emoji</label>
              <input type="text" id="emoji" name="emoji" placeholder="ðŸ " {#ifError 'emoji'}class="error"{/ifError}>
              {#ifError 'emoji'}<span class="error-text">{#error 'emoji'/}</span>{/ifError}
            </div>
            <div class="form-group">
              <label for="title">Title</label>
              <input type="text" id="title" name="title" placeholder="Organization Name" {#ifError 'title'}class="error"{/ifError}>
              {#ifError 'title'}<span class="error-text">{#error 'title'/}</span>{/ifError}
            </div>
          </div>
          <button type="submit" class="cds-btn cds-btn-primary">Create Root</button>
        {/form}
      {/if}
    </div>
  </div>

  <div class="detail-panel">
    {#if selected}
      <div class="box">
        <h2 class="box-header">Edit: {selected.getDisplayLabel}</h2>

        {#form uri:Bommels.update()}
          <input type="hidden" name="id" value="{selected.id}">
          <div class="form-row">
            <div class="form-group emoji-input">
              <label for="edit-emoji">Emoji</label>
              <input type="text" id="edit-emoji" name="emoji" value="{selected.emoji}" {#ifError 'emoji'}class="error"{/ifError}>
              {#ifError 'emoji'}<span class="error-text">{#error 'emoji'/}</span>{/ifError}
            </div>
            <div class="form-group">
              <label for="edit-title">Title</label>
              <input type="text" id="edit-title" name="title" value="{selected.title}" {#ifError 'title'}class="error"{/ifError}>
              {#ifError 'title'}<span class="error-text">{#error 'title'/}</span>{/ifError}
            </div>
          </div>
          <button type="submit" class="cds-btn cds-btn-primary">Save Changes</button>
        {/form}
      </div>

      <div class="box">
        <h3 class="box-header">Add Child to {selected.getDisplayLabel}</h3>

        {#form uri:Bommels.addChild()}
          <input type="hidden" name="parentId" value="{selected.id}">
          <div class="form-row">
            <div class="form-group emoji-input">
              <label for="child-emoji">Emoji</label>
              <input type="text" id="child-emoji" name="emoji" placeholder="ðŸ“" {#ifError 'emoji'}class="error"{/ifError}>
              {#ifError 'emoji'}<span class="error-text">{#error 'emoji'/}</span>{/ifError}
            </div>
            <div class="form-group">
              <label for="child-title">Title</label>
              <input type="text" id="child-title" name="title" placeholder="Child Name" {#ifError 'title'}class="error"{/ifError}>
              {#ifError 'title'}<span class="error-text">{#error 'title'/}</span>{/ifError}
            </div>
          </div>
          <button type="submit" class="cds-btn cds-btn-secondary">Add Child</button>
        {/form}
      </div>

      <div class="box">
        <h3 class="box-header">Danger Zone</h3>
        {#if selected.hasChildren}
          <p>Cannot delete this bommel because it has children. Remove all children first.</p>
          <button type="button" class="cds-btn cds-btn-danger" disabled>Delete Bommel</button>
        {#else}
          {#form uri:Bommels.delete()}
            <input type="hidden" name="id" value="{selected.id}">
            <button type="submit" class="cds-btn cds-btn-danger">Delete Bommel</button>
          {/form}
        {/if}
      </div>
    {#else if root}
      <div class="box">
        <h2 class="box-header">Select a Bommel</h2>
        <p>Click on a bommel in the tree to view and edit its details.</p>
      </div>
    {/if}
  </div>
</div>

{#if flash:success}
  <cds-inline-notification
    kind="success"
    title="Success"
    subtitle="{flash:success}"
    style="position: fixed; bottom: 1rem; right: 1rem;">
  </cds-inline-notification>
{/if}

{#if flash:error}
  <cds-inline-notification
    kind="error"
    title="Error"
    subtitle="{flash:error}"
    style="position: fixed; bottom: 1rem; right: 1rem;">
  </cds-inline-notification>
{/if}

{/include}
